#include <stdio.h>
#include <stdlib.h>
#include <limits.h>
#include <math.h> 

//#include <string.h>

////////////////////////////////////////////////////////////////////////
// Utility Functions

void clean_array (int *grid, int n) {
	int i;
	for (i = 0; i < n; ++i) grid[i] = 0;
}

void random_grid (int grid[][24]) {
	int m, n;
	int i, j;
	n = 4 + rand()%393;
	if (n <= 200) {
		m = 0;
		while (m < n) {
			i = 2 + rand()%20;
			j = 2 + rand()%20;
			if (grid[i][j] == 0) {
				grid[i][j] = 1;
				++m;
			}
		}
	}
	else {
		for (i = 2; i < 22; ++i) for (j = 2; j < 22; ++j) grid[i][j] = 1;
		m = 400;
		while (m > n) {
			i = 2 + rand()%20;
			j = 2 + rand()%20;
			if (grid[i][j] == 1) {
				grid[i][j] = 0;
				--m;
			}
		}
	}
}

int blank_grid(int grid[][24]) {
	int i, j; 
	for (i = 2; i < 22; ++i) for (j = 2; j < 22; ++j) {
		if (grid[i][j] == 1) return 0;
	}
	return 1;
}

void copy_grid (int old_grid[][24], int new_grid[][24]) {
	int i, j;
	for (i = 2; i < 22; ++i) for (j = 2; j < 22; ++j) old_grid[i][j] = new_grid[i][j];
}

void print_grid (int grid[][24]) {
	int i, j;
	for (i = 2; i < 22; ++i) {
		for (j = 2; j < 22; ++j) printf("%d ", grid[i][j]);
		printf("\n");
	}
}

////////////////////////////////////////////////////////////////////////
// IO Functions

void read_train (FILE *train, int *id, int *delta, int *start_grid, int *stop_grid) {
	fscanf (train, "%d,%d,", id, delta);
	int i, j;
	for (i = 2; i < 22; ++i) {
		for (j = 2; j < 22; ++j) fscanf(train, "%d,", &(start_grid[i*24+j]));
	}
	for (i = 2; i < 21; ++i) {
		for (j = 2; j < 22; ++j) fscanf(train, "%d,", &(stop_grid[i*24+j]));
	}
	for (j = 2; j < 21; ++j) fscanf(train, "%d,", &(stop_grid[21*24+j]));
	fscanf(train, "%d\n", &(stop_grid[21*24+21]));
}

void write_pred (FILE *pred, int id, int initial_grid[][24], int pred_grid[][24]) {
	int i, j;
	fprintf(pred, "%d,", id);
	for (i = 2; i < 22; ++i) {
		for (j = 2; j < 22; ++j) fprintf(pred, "%d,", pred_grid[i][j]);
	}
	for (i = 2; i < 21; ++i) {
		for (j = 2; j < 22; ++j) fprintf(pred, "%d,", pred_grid[i][j] - initial_grid[i][j]);
	}
	for (j = 2; j < 21; ++j) fprintf(pred, "%d,", pred_grid[21][j] - initial_grid[21][j]);
	fprintf(pred, "%d\n", pred_grid[21][21] - initial_grid[21][21]);
}

void read_test (FILE *test, int *id, int *delta, int stop_grid[][24]) {
	fscanf (test, "%d,%d,", id, delta);
	int i, j;
	for (i = 2; i < 21; ++i) {
		for (j = 2; j < 22; ++j) fscanf(test, "%d,", &(stop_grid[i][j]));
	}
	for (j = 2; j < 21; ++j) fscanf(test, "%d,", &(stop_grid[21][j]));
	fscanf(test, "%d\n", &(stop_grid[21][21]));
}

void write_submission (FILE *submission, int id, int pred_grid[][24]) {
	int i, j;
	fprintf(submission, "%d,", id);
	for (i = 2; i < 21; ++i) {
		for (j = 2; j < 22; ++j) fprintf(submission, "%d,", pred_grid[i][j]);
	}
	for (j = 2; j < 21; ++j) fprintf(submission, "%d,", pred_grid[21][j]);
	fprintf(submission, "%d\n", pred_grid[21][21]);
}

////////////////////////////////////////////////////////////////////////

void conway_step (int start_grid[][24], int stop_grid[][24]) {
	int i, j, sum;
	for (i = 2; i < 22; ++i) {
		for (j = 2; j < 22; ++j) {
			sum = start_grid[i-1][j-1] + start_grid[i-1][j] + start_grid[i-1][j+1]
				+ start_grid[i][j-1] + start_grid[i][j+1]
				+ start_grid[i+1][j-1] + start_grid[i+1][j] + start_grid[i+1][j+1];
			if (start_grid[i][j] == 1) {
				if (sum > 3) stop_grid[i][j] = 0;
				else if (sum < 2) stop_grid[i][j] = 0;
				else stop_grid[i][j] = 1;
			}
			else if (sum == 3) stop_grid[i][j] = 1;
			else stop_grid[i][j] = 0;
		}
	}
}

int get_pattern_idx (int grid[][24], int i, int j) {
	int pattern = 0;
	int m, n;
	for (m = -2; m <= 2; ++m) {
		for (n = -2; n <= 2; ++n) {
			pattern = pattern << 1;
		pattern += grid[i+m][j+n];
		}
	}
	return pattern;
}

void vote_step (int start_grid[][24], int stop_grid[][24], 
                unsigned int count_case_0[], unsigned int count_case_1[]) {
	int i, j, idx;
	for (i = 2; i < 22; ++i) {
		for (j = 2; j < 22; ++j) {
			// Currently INT_MAX = 2147483647. It is quite safe 
			// so I don't need to check potential overflow.
			// #include <limits.h>
			idx = get_pattern_idx(stop_grid, i, j);
			if (start_grid[i][j] == 0) ++count_case_0[idx];
			else ++count_case_1[idx];
		}
	}
}

int vote_pattern (int pattern, int count_0, int count_1, int delta) {
	double probability;
	if (count_0 + count_1 == 0) probability = 0;
	// for the patterns happen really less frequently, we assume the original center is definitely 0.
	else probability = (double)count_1 / (double)(count_0 + count_1);
	
	if (probability > 0.50) return 1;
	else return 0;
}

void reverse_step (int start_grid[][24], int stop_grid[][24], int vote_case[]) {
	int i, j, idx;
	for (i = 2; i < 22; ++i) {
		for (j = 2; j < 22; ++j) {	
			idx = get_pattern_idx(stop_grid, i, j);
			start_grid[i][j] = vote_case[idx];		
		}
	}
}

double difference_grid (int a_grid[][24], int another_grid[][24]) {
	int i, j;
	int same = 0, different = 0;
	for (i = 2; i < 22; ++i) {
		for (j = 2; j < 22; ++j) {
			if (a_grid[i][j] == another_grid[i][j]) ++same;
			else ++different;
		}
	}
	return (double)different / (double)(same+different);
}

////////////////////////////////////////////////////////////////////////

unsigned int count_case_0[5][33554432], count_case_1[5][33554432]; // 33554432 = pow(2, 25)
int vote_case[5][33554432];

int initial_grid[24][24], start_grid[24][24], stop_grid[24][24];

void random_generator (int loop_num) {
	int n, i, delta;
	
	for (n = 0; n < loop_num; ++n) {
		random_grid(start_grid);
		for (delta = 0; delta < 5; ++delta) {
			conway_step(start_grid, stop_grid);
			copy_grid(start_grid, stop_grid);
		}
		copy_grid(initial_grid, start_grid);
		if (blank_grid(initial_grid)) continue;
		//print_grid(initial_grid);
		for (delta = 0; delta < 5; ++delta) {
			conway_step(start_grid, stop_grid);
			if (blank_grid(stop_grid)) break;
			vote_step(initial_grid, stop_grid, count_case_0[delta], count_case_1[delta]);
			copy_grid(start_grid, stop_grid);
		}
	}
	
	// vote for statistical table
	for (i = 0; i < 5; ++i) {
		for (n = 0; n < 33554432; ++n) {
			vote_case[i][n] = vote_pattern(n, count_case_0[i][n], count_case_1[i][n], i);
			if ((count_case_0[i][n] > INT_MAX/2) || (count_case_1[i][n] > INT_MAX/2)) {
				count_case_0[i][n] = count_case_0[i][n]/2;
				count_case_1[i][n] = count_case_1[i][n]/2;
			}
		}
	}
	
	//printf("%d %d\n", count_case_0[0][0], count_case_1[0][0]);
}

void estimate_train_set () {
	int n, id, delta;
	
	FILE *train;
	train = fopen ("train.csv", "r");
	while (fgetc(train) != '\n') ;  // skip the head line
	
	FILE *pred;
	pred = fopen ("pred.csv", "w");
	fprintf(pred, "id,");
	for (n = 1; n < 401; ++n) fprintf(pred, "start.%d,", n);
	for (n = 1; n < 400; ++n) fprintf(pred, "diff.%d,", n);
	fprintf(pred, "diff.400\n");
	
	double difference_all = 0;
	for (n = 0; n < 50000; ++n) {
		read_train (train, &id, &delta, (int*)initial_grid, (int*)stop_grid);
		reverse_step (start_grid, stop_grid, vote_case[delta-1]);
		write_pred(pred, id, initial_grid, start_grid);
		difference_all += difference_grid(initial_grid, start_grid);
	}
	printf(" %f\n", difference_all/50000);
	fclose(pred);

	fclose(train);
}

void write_submitted_file (int k) {
	int n, id, delta;
	
	FILE *test;
	test = fopen ("test.csv", "r");
	while (fgetc(test) != '\n') ;  // skip the head line
	
	FILE *submission;
	char sub_name[80];
	sprintf(sub_name, "%s%d%s", "submission", k, ".csv");
	submission = fopen (sub_name, "w");
	fprintf(submission, "id,");
	for (n = 1; n < 400; ++n) fprintf(submission, "start.%d,", n);
	fprintf(submission, "start.400\n");
	
	for (n = 0; n < 50000; ++n) {
		read_test(test, &id, &delta, stop_grid);
		
		reverse_step (start_grid, stop_grid, vote_case[delta-1]);
		write_submission(submission, id, start_grid);
	}
	
	fclose(test);
	fclose(submission);
}

////////////////////////////////////////////////////////////////////////

int main () {
	
	// utility parameters
	clean_array((int*)count_case_0, 33554432*5);
	clean_array((int*)count_case_1, 33554432*5);

	clean_array((int*)initial_grid, 24*24);
	clean_array((int*)start_grid, 24*24);
	clean_array((int*)stop_grid, 24*24);
	
	//------------------------------------------------------------------
	
	int k = 1;
	
	while (1) {
		printf("%d ", k*500000); // <= 500000 to avoid overstack
		
		random_generator (500000);
		estimate_train_set ();
		write_submitted_file (k);
		
		++k;
	}
	
	return 0;
}

/*	
500000  0.125382
1000000  0.124343
1500000  0.123802
2000000  0.123454
2500000  0.123179
3000000  0.122988
3500000  0.122831
4000000  0.122682
4500000  0.122562
5000000  0.122464
5500000  0.122375
6000000  0.122292
6500000  0.122220
7000000  0.122132
7500000  0.122072
8000000  0.121998
8500000  0.121947
9000000  0.121908
9500000  0.121873
10000000  0.121828
10500000  0.121788
11000000  0.121747
11500000  0.121713
12000000  0.121678
12500000  0.121632
13000000  0.121596
13500000  0.121559
14000000  0.121537
14500000  0.121505
15000000  0.121491
15500000  0.121470
16000000  0.121448
16500000  0.121433
17000000  0.121398
17500000  0.121399
18000000  0.121376
18500000  0.121359
19000000  0.121341
19500000  0.121322
20000000  0.121307
20500000  0.121291
21000000  0.121268
21500000  0.121255
22000000  0.121232
22500000  0.121216
23000000  0.121194
23500000  0.121190
24000000  0.121170
24500000  0.121168
25000000  0.121155
25500000  0.121143
26000000  0.121140
26500000  0.121130
27000000  0.121127
27500000  0.121119
28000000  0.121119
28500000  0.121104
29000000  0.121097
29500000  0.121083
30000000  0.121079
30500000  0.121064
31000000  0.121057
31500000  0.121051
32000000  0.121040
32500000  0.121030
33000000  0.121027
33500000  0.121023
34000000  0.121010
34500000  0.121006
35000000  0.121003
35500000  0.120997
36000000  0.120991
36500000  0.120975
37000000  0.120972
37500000  0.120959
38000000  0.120958
38500000  0.120955
39000000  0.120945
39500000  0.120939
40000000  0.120938
40500000  0.120931
41000000  0.120934
41500000  0.120928
42000000  0.120922
42500000  0.120918
43000000  0.120905
43500000  0.120902
44000000  0.120895
44500000  0.120883
45000000  0.120874
45500000  0.120872
46000000  0.120870
46500000  0.120870
47000000  0.120864
47500000  0.120860
48000000  0.120853
48500000  0.120855
49000000  0.120859
49500000  0.120857
50000000  0.120862
50500000  0.120853
51000000  0.120846
51500000  0.120837
52000000  0.120832
52500000  0.120816
53000000  0.120814
53500000  0.120815
54000000  0.120807
54500000  0.120806
55000000  0.120805
55500000  0.120810
56000000  0.120809
56500000  0.120796
57000000  0.120792
57500000  0.120792
58000000  0.120787
58500000  0.120785
59000000  0.120781
59500000  0.120775
60000000  0.120778
60500000  0.120775
61000000  0.120767
61500000  0.120766
62000000  0.120769
62500000  0.120769
63000000  0.120767
63500000  0.120763
64000000  0.120750
64500000  0.120752
65000000  0.120747
65500000  0.120735
66000000  0.120734
66500000  0.120727
67000000  0.120725
67500000  0.120722
68000000  0.120712
68500000  0.120718
69000000  0.120718
69500000  0.120714
70000000  0.120710
70500000  0.120704
71000000  0.120709
71500000  0.120705
72000000  0.120703
72500000  0.120710
73000000  0.120705
73500000  0.120697
74000000  0.120696
74500000  0.120691
75000000  0.120688
75500000  0.120688
76000000  0.120685
76500000  0.120687
77000000  0.120681
77500000  0.120680
78000000  0.120677
78500000  0.120680
79000000  0.120677
79500000  0.120675
80000000  0.120667
80500000  0.120659
81000000  0.120657
81500000  0.120659
82000000  0.120657
82500000  0.120653
83000000  0.120654
83500000  0.120650
84000000  0.120646
84500000  0.120648
85000000  0.120647
85500000  0.120643
86000000  0.120640
86500000  0.120642
87000000  0.120640
87500000  0.120642
88000000  0.120633
88500000  0.120635
89000000  0.120631
89500000  0.120628
90000000  0.120624
90500000  0.120621
91000000  0.120620
91500000  0.120625
92000000  0.120633
92500000  0.120634
93000000  0.120632
93500000  0.120626
94000000  0.120624
94500000  0.120621
95000000  0.120616
95500000  0.120617
96000000  0.120615
96500000  0.120611
97000000  0.120611
97500000  0.120610
98000000  0.120612
98500000  0.120613
99000000  0.120612
99500000  0.120614
100000000  0.120610
100500000  0.120608
101000000  0.120605
101500000  0.120607
102000000  0.120606
102500000  0.120601
103000000  0.120598
103500000  0.120603
104000000  0.120602
104500000  0.120599
105000000  0.120598
105500000  0.120594
106000000  0.120597
106500000  0.120593
107000000  0.120595
107500000  0.120594
108000000  0.120590
108500000  0.120583
109000000  0.120583
109500000  0.120586
110000000  0.120583
110500000  0.120588
111000000  0.120588
111500000  0.120587
112000000  0.120582
112500000  0.120579
113000000  0.120577
113500000  0.120577
114000000  0.120576
114500000  0.120575
115000000  0.12057
115500000  0.120569 ~ 0.11796
116000000  0.120567
116500000  0.120570
117000000  0.120566
117500000  0.120571
118000000  0.120571
118500000  0.120570
119000000  0.120565
119500000  0.120562
120000000  0.120555
120500000  0.120560
121000000  0.120560
121500000  0.120559
122000000  0.120554
122500000  0.120552
123000000  0.120556
123500000  0.120555
124000000  0.120554
124500000  0.120552
125000000  0.120553
125500000  0.120551
126000000  0.120552
126500000  0.120552
127000000  0.120552
127500000  0.120546
128000000  0.120545
128500000  0.120549
129000000  0.120549
129500000  0.120543
130000000  0.120538
130500000  0.120540
131000000  0.120536
131500000  0.120537
132000000  0.120540
132500000  0.120538
133000000  0.120541
133500000  0.120539
134000000  0.120540
134500000  0.120534
135000000  0.120535
135500000  0.120532
136000000  0.120531
136500000  0.120530
137000000  0.120530
137500000  0.120532
138000000  0.120535
138500000  0.120535
139000000  0.120532
139500000  0.120531
140000000  0.120529
140500000  0.120528
141000000  0.120527
141500000  0.120528
142000000  0.120531
142500000  0.120529
143000000  0.120531
143500000  0.120529
144000000  0.120530
144500000  0.120527
145000000  0.120525
145500000  0.120522
146000000  0.120521
146500000  0.120521
147000000  0.120519
147500000  0.120520
148000000  0.120519
148500000  0.120520
149000000  0.120518
149500000  0.120521
150000000  0.120523
150500000  0.120523
151000000  0.120521
151500000  0.120518
152000000  0.120518
152500000  0.120519
153000000  0.120521
153500000  0.120519
154000000  0.120518
154500000  0.120520
155000000  0.120520
155500000  0.120515
156000000  0.120515
156500000  0.120518
157000000  0.120517
157500000  0.120518
158000000  0.120517
158500000  0.120516
159000000  0.120512
159500000  0.120516
160000000  0.120515
160500000  0.120514
161000000  0.120512
161500000  0.120512
162000000  0.120512
162500000  0.120511
163000000  0.120508
163500000  0.120509
164000000  0.120508
164500000  0.120509
165000000  0.120508
165500000  0.120507
166000000  0.120505
166500000  0.120503
167000000  0.120503
167500000  0.120500
168000000  0.120499
168500000  0.120499
169000000  0.120497
169500000  0.120497
170000000  0.120494
170500000  0.120490
171000000  0.120492
171500000  0.120493
172000000  0.120494
172500000  0.120491
173000000  0.120489
173500000  0.120490
174000000  0.120487
174500000  0.120487
175000000  0.120485
175500000  0.120484
176000000  0.120482
176500000  0.120481
177000000  0.120481
177500000  0.120478
178000000  0.120479
178500000  0.120479
179000000  0.120479
179500000  0.120478
180000000  0.120476
180500000  0.120477
181000000  0.120480
181500000  0.120480
182000000  0.120479
182500000  0.120481
183000000  0.120478
183500000  0.120475
184000000  0.120475
184500000  0.120476
185000000  0.120476
185500000  0.120472
186000000  0.120477
186500000  0.120477
187000000  0.120478
187500000  0.120475
188000000  0.120474
188500000  0.120476
189000000  0.120479
189500000  0.120472
190000000  0.120474
190500000  0.120473
191000000  0.120473
191500000  0.120471
192000000  0.120475
192500000  0.120475
193000000  0.120472
193500000  0.120471
194000000  0.120474
194500000  0.120475
195000000  0.120474
195500000  0.120473
196000000  0.120471
196500000  0.120471
197000000  0.120467
197500000  0.120467
198000000  0.120467
198500000  0.120468
199000000  0.120466
199500000  0.120460
200000000  0.120461
200500000  0.120464
201000000  0.120460
201500000  0.120460
202000000  0.120460
202500000  0.120463
203000000  0.120462
203500000  0.120459
204000000  0.120460
204500000  0.120462
205000000  0.120460
205500000  0.120459
206000000  0.120456
206500000  0.120459
207000000  0.120457
207500000  0.120458
208000000  0.120455
208500000  0.120454
209000000  0.120455
209500000  0.120456
210000000  0.120455
210500000  0.120453
211000000  0.120454
211500000  0.120452
212000000  0.120451
212500000  0.120452
213000000  0.120451
213500000  0.120449
214000000  0.120451
214500000  0.120450
215000000  0.120450
215500000  0.120449
216000000  0.120450
216500000  0.120447
217000000  0.120445
217500000  0.120443
218000000  0.120445
218500000  0.120445
219000000  0.120440
219500000  0.120441
220000000  0.120441
220500000  0.120439
221000000  0.120439
221500000  0.120437
222000000  0.120440
222500000  0.120440
223000000  0.120439
223500000  0.120437
224000000  0.120437
224500000  0.120438
225000000  0.120434
225500000  0.120435
226000000  0.120432
226500000  0.120432
227000000  0.120433
227500000  0.120434
228000000  0.120434
228500000  0.120432
229000000  0.120434
229500000  0.120434
230000000  0.120430
230500000  0.120430 ~ 0.11787
231000000  0.120434
*/

